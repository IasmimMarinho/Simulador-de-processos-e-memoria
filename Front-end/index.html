<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/gantt.js"></script>
    <script src="../Back-end/scheludingCalculator.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Escalonador de processos</title>

</head>
<body>
    <div id="container_view">
    <header id="cabecalho">Digite os dados do sistema e de cada processo</header>
    <div id="inputs-container">
        <input type="number" id="quantidade-processos" placeholder="Quantidade de processos">
    </div> 

    <script>
        let numProcessos;
        let quantum;
        let sobrecarga;
        let processes = [];
        let selectedAlgorithm;
        var header = document.getElementById("cabecalho");
        
        function pedirQuantidadeProcessos() {
            numProcessos = parseInt(document.getElementById("quantidade-processos").value);
            limparInputs();
            pedirQuantum();
        }

        function pedirQuantum() {
            const inputQuantum = criarInput("number", "Valor do quantum");
            inputQuantum.addEventListener("change", () => {
                quantum = parseInt(inputQuantum.value);
                limparInputs();
                pedirSobrecarga();
            });
            document.getElementById("inputs-container").appendChild(inputQuantum);
        }

        function pedirSobrecarga() {
            const inputSobrecarga = criarInput("number", "Valor da sobrecarga");
            inputSobrecarga.addEventListener("change", () => {
                sobrecarga = parseInt(inputSobrecarga.value);
                limparInputs();
                pedirProcessos(0);
            });
            document.getElementById("inputs-container").appendChild(inputSobrecarga);
        }

        function pedirProcessos(index) {
            if (index < numProcessos) {
                const inputTempoChegada = criarInput("number", `Tempo de chegada do processo ${index + 1}`);
                const inputTempoExecucao = criarInput("number", `Tempo de execução do processo ${index + 1}`);
                const inputDeadline = criarInput("number", `Deadline do processo ${index + 1}`);

                const divProcesso = document.createElement("div");
                divProcesso.appendChild(inputTempoChegada);
                divProcesso.appendChild(inputTempoExecucao);
                divProcesso.appendChild(inputDeadline);

                document.getElementById("inputs-container").appendChild(divProcesso);

                const proximoIndex = index + 1;

                inputDeadline.addEventListener("change", () => {
                    processes.push({
                        arrival: parseInt(inputTempoChegada.value),
                        execution: parseInt(inputTempoExecucao.value),
                        deadline: parseInt(inputDeadline.value)
                    });

                    limparInputs();
                    pedirProcessos(proximoIndex);
                });
            } else {
                header.innerHTML = "Escolha o algoritmo de escalonamento";
                console.log("Quantidade de Processos:", numProcessos);
                console.log("Quantum:", quantum);
                console.log("Sobrecarga:", sobrecarga);
                console.log("Processos:", processes);

                const calculator = new SchedulingCalculator(JSON.parse(JSON.stringify(processes)), quantum, sobrecarga);

                const fifoResult = calculator.fifo();
                console.log("Turnaround FIFO: ", fifoResult);
                const sjfResult = calculator.sjf();
                console.log("Turnaround SJF: ", sjfResult);
                const roundRobinResult = calculator.roundRobin();
                console.log("Turnaround Round Robin: ", roundRobinResult);
                const edfResult = calculator.edf();
                console.log("Turnaround EDF: ", edfResult);

                const fifo = criarButton("FIFO", "1");
                const sjf = criarButton("SJF", "2");
                const roundRobin = criarButton("Round Robin", "3");
                const edf = criarButton("EDF", "4");
                document.getElementById("inputs-container").appendChild(fifo);
                document.getElementById("inputs-container").appendChild(sjf);
                document.getElementById("inputs-container").appendChild(roundRobin);
                document.getElementById("inputs-container").appendChild(edf);

                fifo.addEventListener("click", () => { selectedAlgorithm = fifoResult; getGraphic(); });
                sjf.addEventListener("click", () => { selectedAlgorithm = sjfResult; getGraphic(); });
                roundRobin.addEventListener("click", () => { selectedAlgorithm = roundRobinResult; getGraphic(); });
                edf.addEventListener("click", () => { selectedAlgorithm = edfResult; getGraphic(); });        
            }
        }

        function criarButton(title, id) {
            const button = document.createElement("button");  
            button.textContent = title; 
            button.id = id;
            return button;
        }

        function criarInput(type, placeholder) {
            const input = document.createElement("input");
            input.type = type;
            input.placeholder = placeholder;
            return input;
        }

        function limparInputs() {
            document.getElementById("inputs-container").innerHTML = "";
        }
        function getResult(result) {
            const trResult = result.toFixed(2); 
            const label = document.createElement("label");
            label.textContent = `Turnaround: ${trResult}`;
            document.getElementById("ResultLabel").appendChild(label);
            return label;

        }
        document.getElementById("quantidade-processos").addEventListener("change", pedirQuantidadeProcessos);

        function getGraphic() {
            
            Highcharts.ganttChart('container', {

                title: {
                    text: 'Gantt Chart process scheduler',
                    align: 'left'
                },
                chart: {
                    borderColor: '#686868',
                    borderWidth: 2,
                    animation: {
                    defer: 1000
                    }
                },

                xAxis: {
                    categories: Array.from({ length: 31 }, (_, i) => i), // Gera uma array de 0 a 30
                    min: 0,
                    max: 30,
                },
                tooltip: {
                    formatter: function () {
                        return '<b>' + 'Task: ' + this.point.name + '<br/>' +
                            'Start: ' + this.point.start + '<br/>' +
                            'End: ' + this.point.end;
                    }
                },

                accessibility: {
                    point: {
                        descriptionFormat: '{yCategory}. ' +
                            '{#if completed}Task {(multiply completed.amount 100):.1f}% completed. {/if}' +
                            'Start {x}, end {x2}.'
                    }
                },

                series: [{
                    name: 'Project 1',
                    data: processes.map((item, index) => ({
                        name: `Processo ${index + 1}`,
                        start: item.arrival,
                        end: item.execution,
                        color: 'green'
                    })),
                    // adciona delay
                    animation: {
                        defer: 1000,
                    }
                }]
            });
            
            document.getElementById("ResultLabel").innerHTML = "";
            getResult(selectedAlgorithm)
        }

    </script>

    <div id="container"></div>
</div>
<label id="ResultLabel"></label>
</body>
</html>
